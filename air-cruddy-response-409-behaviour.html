<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="air-cruddy-differential-behaviour.html">

<script>
    /**
     * FiveElements Namespace definition
     */
    var FiveElements = FiveElements || {};

    /**
     * @polymerBehavior
     */
    FiveElements.AirCruddyResponse409BehaviorImpl = {

        properties: {
            dataUser: {
                type: Object
            },
            dataOrigin: {
                type: Object
            }
        },


        listeners: {
            'air-cruddy-response-get': '_handleGetForConflictBeResolution'
        },

        // --- Api
        // --- ---------------------

        _handleErrorUpdate409: function (event) {
            if (typeof  this.beginConflictBeResolution === 'function') {
                this._beginConflictBeResolution();
            }
            // Reload Data anyway, what else could you do in this case !!! (Sorry for Your lost)
            console.log('begin Conflict Resolution for entity :', this.entityId);
            this._entityGet(this.entityId);
        },

 
        // --- Api
        // --- ---------------------

        isConflictBeResolution: function () {
            return  this.dataUser !== undefined;
        },
        endConflictBeResolution: function () {
            this.dataUser = undefined;
            this.dataOrigin = undefined;
        },

        // --- Conflict Resolution
        // --- ---------------------
        _beginConflictBeResolution: function () {
            console.log('markToConflictToBeResolve -- BEGIN', this.data, this.dataOri);
            this.dataUser = JSON.parse(JSON.stringify(this.data));
            this.dataOrigin = JSON.parse(JSON.stringify(this.dataOri));
            console.log('markToConflictToBeResolve -- END');
        },


        _handleGetForConflictBeResolution: function (event) {
            if (this.isConflictBeResolution()) {
                var detail = event.detail;
                var userDiff = this.mergeConflict();
                if (userDiff.userDiffConflict) {
                    // TODO Real Conflict without resolution ??
                }
                console.log('------- _handleGetForConflictBeResolution : ', detail);
            }
        },

        // --- Conflict Resolution
        // --- ---------------------
        mergeConflict: function () {
            var userDiff = this.computeUserDiff();
            // Merge Not Conflict
            if (userDiff.userDiffMergeable) {
                // FIXME is link to model
                this.copyObjectAttributes(userDiff.userDiffMergeable, this.data._source, true);
                this.notifyPath('data._source', userDiff.userDiffMergeable);
            }
            if (userDiff.userDiffConflict) {
                // TODO Unmergeable Conflict
            }
            this.endConflictBeResolution();
            console.log('---------- Conflict resolution END');
            return userDiff;
        },
        /**
         * Call after server get (witch change this.data),
         * and compare with the data backup in (this.dataUser, this.dataOrigin).
         *
         * Call markToConflictToBeResolve before to save states.
         */
        computeUserDiff: function () {
            // Field that the user want to update (compare version n and n+2)
            var diffUser = this._diffProperties(this.dataOrigin._source, this.dataUser._source);
            // Fields modify in server side between the the edit form time. (compare version n and n+1)
            var diffServer = this._diffProperties(this.dataOrigin._source, this.data._source);
            // Compute conflict
            var userDiffMergeable = this.userDiffNotInServerProperties(diffServer, diffUser);
            var userDiffConflict = this.userDiffInServerProperties(diffServer, diffUser);
            // Result
            var result = {
                modifByUser: diffUser,
                modifByServer: diffServer,
                userDiffMergeable: userDiffMergeable,
                userDiffConflict: userDiffConflict
            };
            console.log('Diff User', result);
            return result;
        },
        // --- Differential
        // --- ---------------------
        // Intersect
        userDiffInServerProperties: function (server, client, conflict) {
            conflict = conflict || {};
            if (client && server) {
                for (var attr in client) {
                    if (server.hasOwnProperty(attr) && client.hasOwnProperty(attr)) {
                        conflict[attr] = client[attr];
                    }
                }
            }
            return this._isEmptyObj(conflict) ? undefined : conflict;
        },
        userDiffNotInServerProperties: function (server, client, conflict) {
            conflict = conflict || {};
            if (client) {
                for (var attr in client) {
                    if (client.hasOwnProperty(attr) && !server.hasOwnProperty(attr)) {
                        conflict[attr] = client[attr];
                    }
                }
            }
            return this._isEmptyObj(conflict) ? undefined : conflict;
        },
        // --- Tools
        // --- ---------------------
        copyObjectAttributes: function (src, dest, override) {
            dest = dest || {};
            if (!src) {
                return dest;
            }
            for (var attr in src) {
                if (typeof src[attr] === 'object' && !Array.isArray(src[attr])) {
                    // console.log('copyProperties type : ', attr, ' --> ', typeof src[attr], ' / is Array '  , Array.isArray(src[attr]) );
                    if (override || !dest.hasOwnProperty(attr)) {
                        var subDest = this.copyObjectAttributes(src[attr], dest[attr], override);
                        // console.log('sub dest', subDest);
                        dest[attr] = subDest;
                    }
                } else if (src.hasOwnProperty(attr)) {
                    if (override || !dest.hasOwnProperty(attr)) {
                        dest[attr] = src[attr];
                    }
                }
            }
            return dest;
        }
        // --- Other
        // --- ---------------------

    };

    /**
     * @polymerBehavior
     */
    FiveElements.AirCruddyResponse409Behavior = [FiveElements.AirCruddyDifferentialBehavior,  FiveElements.AirCruddyResponse409BehaviorImpl];


</script>