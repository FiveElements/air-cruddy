<link rel="import" href="../polymer/polymer.html">
<script src="../lodash/lodash.js"></script>

<script>
    /**
     * FiveElements Namespace definition
     */
    var FiveElements = FiveElements || {};

    /**
     * @polymerBehavior
     */
    FiveElements.AirCruddyDirtyBehavior = {

        properties: {

            crudStatus: {
                type: String,
                notify: true
            },

            // -- Internal
            // -----------------------

            /**
             * Contains an map all dirty field
             */
            dataSourceDirtyDetailStatus: {
                type: Object,
                notify: true,
                value: function () {
                    return {}
                }
            }
        },

        observers: [
            'dataSourceChanged(data._source.*)'
        ],

        listeners: {
            'air-cruddy-response-get': '_handleResponseGetForDirtyStatus',
            'air-cruddy-response-create': '_handleResponseCreateForDirtyStatus',
            'air-cruddy-response-update': '_handleResponseUpdateForDirtyStatus',
            'air-cruddy-response-delete': '_handleResponseDeleteForDirtyStatus'
        },


        // --- Life Cycle
        // --- ---------------------------


        // --- External Api to be call
        // --- ---------------------
        _handleResponseGetForDirtyStatus: function (event) {

        },

        _handleResponseCreateForDirtyStatus: function (event) {

        },

        _handleResponseUpdateForDirtyStatus: function (event) {
        },

        _handleResponseDeleteForDirtyStatus: function (event) {

        },

        // --- Value Comparator
        // --- ---------------------

        _isArrayEquals: function (one, two) {
            // if the other two is a falsy value, return
            if (!two)
                return false;

            // compare lengths - can save a lot of time
            if (one.length != two.length)
                return false;

            for (var i = 0, l = one.length; i < l; i++) {
                // Check if we have nested arrays
                if (one[i] instanceof Array && two[i] instanceof Array) {
                    // recurse into the nested arrays
                    if (!one[i].equals(two[i]))
                        return false;
                }
                else if (one[i] != two[i]) {
                    // Warning - two different object instances will never be equal: {x:20} != {x:20}
                    return false;
                }
            }
            return true;
        },


        // --- Logic
        // --- ---------------------


        isDataDirty: function () {
            return Object.keys(this.dataSourceDirtyDetailStatus).length > 0;
        },

        // --- Value Comparator
        // --- ---------------------

        _isValueEqual: function (dataRef, data) {
            return _.isEqual(dataRef, data);
        },

        // --- Logic
        // --- ---------------------
        _computeCrudStatus: function (dataSourceDirtyDetailStatus, isModeCreate) {
            var status = 'R';
            var isDiff = Object.keys(dataSourceDirtyDetailStatus).length > 0;
            if (isModeCreate) {
                status = 'C';
            } else {
                if (isDiff) {
                    status = 'U';
                } else {
                    status = 'R';
                }
            }
            console.log('--- Crud Status : ---> ', status);
            this.crudStatus = status;
            return status;
        },

        

        dataSourceChanged: function (changeRecord) {
            console.log('### ', changeRecord.path + ' changed to ' + changeRecord.value);

            // Compare the Change to Origin loaded data
            // -----------------------------------------
            // Extract the object prefix : 'data.'.length = 5
            var pathChanged = changeRecord.path.slice(5);
            // Compare with the original Value
            var valueOri = this.get(pathChanged, this.dataOri);
            var isValueEqual = this._isValueEqual(valueOri, changeRecord.value);
            console.log('isValueEqual =', isValueEqual, ' // ', changeRecord.value, ' ?=? ', valueOri);

            // Manage Change Field List
            // -------------------------
            if (isValueEqual) {
                if ('_source' === pathChanged) {
                    this.dataSourceDirtyDetailStatus = {};
                } else {
                    delete this.dataSourceDirtyDetailStatus[pathChanged]
                }
            } else {
                this.dataSourceDirtyDetailStatus[pathChanged] = true;
                //  this.set(path, true, this.dataSourceDirtyDetailStatus);
            }
            console.log('dataSourceDirtyDetailStatus : ', this.dataSourceDirtyDetailStatus);
            // Status Compute
            this._computeCrudStatus(this.dataSourceDirtyDetailStatus, this._isModeCreate);


        }

    };

</script>
