<link rel="import" href="../polymer/polymer.html">

<script src="../lodash/lodash.js"></script>

<script>
    /**
     * FiveElements Namespace definition
     */
    var FiveElements = FiveElements || {};

    /**
     * @polymerBehavior
     */
    FiveElements.AirCruddyDirtyBehavior = {

        properties: {

            /**
             * The Crud Status :
             *  C : Creating, (Need to be Save)
             *  R : Read for service, (No modification)
             *  U : Updating, Read and is Modify (Need to be Save)
             */
            crudStatus: {
                type: String,
                notify: true
            },

            autoSave: {
                type: Boolean,
                value: false
            },

            autoSaveWait: {
                type: Number
            },

            // -- Internal
            // -----------------------

            /**
             * Contains an map all dirty field
             */
            dataSourceDirtyDetailStatus: {
                type: Object,
                notify: true,
                value: function () {
                    return {}
                }
            }
        },

        listeners: {
            'focusout': '_handleBlur'
        },

        observers: [
            'dataSourceChanged(data.*)'
        ],


        // --- Life Cycle
        // --- ---------------------------

        _handleBlur: function (event) {
           // console.log('Handle Blur ', event.srcElement);
            if (this.autoSave && this.isDataDirty()) {
                this._doAutoSaveAsync();
            }
        },
        _doAutoSave: function () {
            if (this.isDataDirty()) {
               // console.log('Call Save from AutoSave');
                this.save();
            }
        },

        _doAutoSaveAsync: function () {
            this.debounce('air-cruddy-autosave', this._doAutoSave.bind(this), this.autoSaveWait);
        },

        // --- Logic
        // --- ---------------------

        isDataDirty: function () {
            switch (this.crudStatus) {
                case 'C':
                case 'U':
                    return true;
                default :
                    return false;
            }
        },


        // --- Logic
        // --- ---------------------
        _computeCrudStatus: function (dataSourceDirtyDetailStatus, isModeCreate) {
            var status = 'R';
            var isDiff = Object.keys(dataSourceDirtyDetailStatus).length > 0;
            if (isModeCreate) {
                status = 'C';
            } else {
                if (isDiff) {
                    status = 'U';
                } else {
                    status = 'R';
                }
            }
           // console.log('--- --- --- Crud Status : ---> ', status);
            this.crudStatus = status;
            return status;
        },

        // --- Value Comparator
        // --- ---------------------

        _isValueEqual: function (dataRef, data) {
            return _.isEqual(dataRef, data);
        },

        // --- Dirty Changed
        // --- ---------------------
        dataSourceChanged: function (changeRecord) {
            //console.log('### ', changeRecord.path + ' changed to ' + changeRecord.value, ' // ', changeRecord);

            // Compare the Change to Origin loaded data
            // -----------------------------------------
            // Extract the object prefix : 'data.'.length = 5
            var pathChanged = changeRecord.path.slice(5);
            var isValueEqual = true;
            switch (pathChanged) {
                case '':
                case '_source':
                case '_version':
                    this.dataSourceDirtyDetailStatus = {};
                    isValueEqual = true;
                    break;
                default:
                    if (pathChanged.indexOf('_source.') === 0) {
                        var valueOri = this.get(pathChanged, this.dataOri);
                        isValueEqual = this._isValueEqual(valueOri, changeRecord.value);
                        //  console.log('isValueEqual =', isValueEqual, ' // ', changeRecord.value, ' ?=? ', valueOri);
                    } else {
                        console.warn("Change Path Not manage : ", changeRecord.path);
                    }
            }
            // Manage Change Field List
            // -------------------------
            if (isValueEqual) {
                delete this.dataSourceDirtyDetailStatus[pathChanged]
            } else {
                this.dataSourceDirtyDetailStatus[pathChanged] = true;
            }
            //console.log('dataSourceDirtyDetailStatus : ', this.dataSourceDirtyDetailStatus);

            // Status Compute
            // -------------------------
            this._computeCrudStatus(this.dataSourceDirtyDetailStatus, this._isModeCreate);
        }

    };

</script>
