<link rel="import" href="../polymer/polymer.html">

<script>
    'use strict';

    /**
     * FiveElements Namespace definition
     */
    var FiveElements = FiveElements || {};

    /**
     * @polymerBehavior
     */
    FiveElements.AirCruddyBehavior = {

        properties: {
            /**
             * Auto Save
             */
            autoSave: {
                type: Boolean,
                value: false
            },
            /**
             * Url endpoint of the Rest Web-Service
             */
            url: {
                type: String
            },
            /**
             * Entity Id of the resource to CRUD
             */
            entityId: {
                type: String,
                notify: true
            },
            /**
             * The data load from the URL endpoint of the Rest Web-Service
             */
            data: {
                type: Object,
                notify: true
            },
            /**
             * A backup of the Data Load
             */
            _dataOrigin: {
                type: Object
            },
            /**
             * Fetch Configuration
             *  mode: The mode you want to use for the request, e.g., cors, no-cors, same-origin, or navigate.
             */
            mode: {
                type: String,
                value: 'cors'
            },

            /**
             * Fetch Configuration
             * cache: The cache mode you want to use for the request.
             */
            cache: {
                type: String,
                value: 'default'
            },

            /**
             * Fetch Configuration
             * redirect: The redirect mode to use: follow, error, or manual. In Chrome the default is follow
             */
            redirect: {
                type: String,
                value: 'follow'
            },
            /**
             * Fetch Configuration
             * referrer: A USVString specifying no-referrer, client, or a URL. The default is client.
             */
            referrer: {
                type: String,
                value: 'client'
            }
        },

        observers: [
            '_autosaveObserver(autoSave,data.*)'
        ],

        // --- Changed Observer
        // --- ---------------------------
        _autosaveObserver: function (autoSave, dataChange) {
            if (autoSave) {
//                    this.save();
            }
        },

        // --- mock
        // --- ---------------------------

        retrieveById: function (entityId) {
            console.log("Request Retrieve: ", entityId);
            this.entityId = '404';
            this._fetchPromiseRetrieve('404').catch(function (error) {
                console.log('post error', error);
            });
        },


        // --- API
        // --- ---------------------------
        /**
         * Retrieve the resource from the Rest Web Service
         * @param entityId The entityId to load or if not defined the entityId deine in the 'air-cruddy' Web-Componnent
         */
        retrieve: function (entityId) {
//                var loadId = entityId || this.entityId;
            var loadId = this.entityId;
            this._fetchPromiseRetrieve(loadId);
        },

        update: function () {
            this._fetcPromiseUpdate(this.entityId, this.data);
        },

        delete: function () {
            this._fetchPromiseDelete(this.entityId, this.data);
        },

        create: function () {
            console.log('create data add ', this.data);
            this._fetchPromiseCreate(null, this.data);
        },

        newEntity: function () {
            this.entityId = null;
            this.data = {};

        },

        clean: function () {
            this.entityId = null;
            this.data = null;
            this._dataOrigin = null;
        },

        // --- API Adapter
        // --- ---------------------------

        _defaultHearders: function () {
            var myHeaders = new Headers({
                'Content-Type': 'application/json' // "text/plain"
            });
            return myHeaders;
        },

        /**
         *
         * @param method
         * @param data
         * @returns {{method: *, mode: *, headers: *}}
         * @private
         */
        _defaultOptions: function (method, data) {
            var content = undefined;
            var myHeaders = this._defaultHearders();
            // https://developer.mozilla.org/en-US/docs/Web/API/Request/Request
            // method: The request method, e.g., GET, POST.
            // credentials: The request credentials you want to use for the request: omit, same-origin, or include. The default is omit.
            // integrity: Contains the subresource integrity value of the request (e.g., sha256-BpfBw7ivV8q2jLiT13fxDYAe2tJllusRSZ273h2nFSE=). (https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity)
            var init = {
                method: method,
                mode: this.mode,
                cache: this.cache,
                redirect: this.redirect,
                referrer: this.referrer,
                headers: myHeaders
            };
            return init;
        },

        _fetchInitAddData: function (init, data) {
            var content = undefined;
            if (data) {
                content = this._dataSerializerEntity(data);
            }
            if (content) {
                var contentLength = content.length;
                init.body = content;
                var myHeaders = init.headers || new Headers();
                myHeaders.append("Content-Length", contentLength.toString());
            }
            return init;
        },

//            _computeDataIntegrity: function(content) {
//                var integrityAlgo = 'SHA-256'; // allowed prefixes are sha256, sha384, and sha512
//                var buffer = new TextEncoder("utf-8").encode(content);
//                return crypto.subtle.digest(integrityAlgo, buffer).then(function (hash) {
//                    return base64(hash);
//                };
//            },


        _fetchUrlEntityId: function (entityId, version) {
            var url = this.url + '/' + entityId;
            if (version) {
                url += '?version=' + version;
            }
            return url;
        },

        _fetchUrlRoot: function () {
            return this.url;
        },


        // --- Data Serialiser
        // --- ---------------------------

        // --- Internal Promise
        // --- ---------------------------
        _transformResponseJson: function (response) {
//                if (this._isResponseJson(response)) {
            return response.json();
        },

        _fetchRequest: function (init) {
            var url = init.url;
            delete init.url;
            return window.fetch(url, init);
        },


        // --- Elasticsearch API Transformer
        // --- ---------------------------
        _dataSerializerEntity: function (data) {
            return JSON.stringify(data);
        },

        /**
         * Adapt response from Retrieve Web-Service o the expected format
         * '''
         * {
             *   id: '',
             *   version: '',
             *   ...
             * }
         * '''
         */
        _adapterResponseRetrieve: function (responseJson) {
            var data = JSON.parse(JSON.stringify(responseJson._source));
            data.id = responseJson._id;
            data.version = responseJson._version;
            return data;
        },
        /**
         * Adapt response from Update Web-Service o the expected format
         * '''
         * {
             *   id: '',
             *   version: '',
             *   ...
             * }
         * '''
         */
        _adapterResponseUpdate: function (responseJson) {
            var adaptJson = {
                id: responseJson._id,
                version: responseJson._version
            };
            return Object.assign(adaptJson, {origin: responseJson});
        },

        /**
         * Adapt response from Delete Web-Service o the expected format
         * '''
         * {
             *   id: 'The new entity Id',
             *   version: 'The version',
             *   ...
             * }
         * '''
         */
        _adapterResponseDelete: function (responseJson) {
            var adaptJson = {
                id: responseJson._id,
                version: responseJson._version
            };
            return Object.assign(adaptJson, {origin: responseJson});
        },

        /**
         * Adapt response from Create Web-Service o the expected format
         * '''
         * {
             *   id: 'The new entity Id',
             *   version: 'The version',
             *   ...
             * }
         * '''
         */
        _adapterResponseCreate: function (responseJson) {
            var adaptJson = {
                id: responseJson._id,
                version: responseJson._version
            };
            return Object.assign(adaptJson, {origin: responseJson});
        },


        _transformToServerSave: function (dataToSave) {
            var data = JSON.parse(JSON.stringify(dataToSave));
            delete data.id;
            delete data.version;
            return data;
        },

        _transformToServerSavePartial: function (dataToSave) {
            // Manage Differential
            var data = JSON.parse(JSON.stringify(dataToSave));
            delete data.id;
            delete data.version;
            return {
                "doc": data
            };
        },

        // --- Elasticsearch API
        // --- -------------------------------
        _fetchUrlRetrieve: function (entityId, version) {
            return this._fetchUrlEntityId(entityId, version);
        },

        _fetchUrlUpdate: function (entityId, version) {
            return this._fetchUrlEntityId(entityId, version);
        },

        _fetchUrlDelete: function (entityId, version) {
            return this._fetchUrlEntityId(entityId, version);
        },

        _fetchUrlCreate: function (entityId, version) {
            return this._fetchUrlRoot();
        },

        // --- Fetch Request
        // --- -------------------------------

        _fetchInitRetrieve: function (entityId) {
            var self = this;
            console.log('entityId', entityId);
            return new Promise(function (resolve, reject) {
                var urlGet = self._fetchUrlRetrieve(entityId);
                var opt = self._defaultOptions('GET');
                resolve(Object.assign(opt, {url: urlGet}));
            });
        },

        _fetchInitUpdate: function (entityId, data) {
            var self = this;
            return new Promise(function (resolve, reject) {
                var version = data ? data.version : null;
                var urlUpdate = self._fetchUrlUpdate(entityId, version);
                var opt = self._defaultOptions('PUT', data);
                resolve(Object.assign(opt, {url: urlUpdate}));
            });
        },


        _fetchInitDelete: function (entityId, data) {
            var self = this;
            return new Promise(function (resolve, reject) {
                var version = data ? data.version : null;
                var urlDelete = self._fetchUrlDelete(entityId, version);
                var opt = self._defaultOptions('DELETE', data);
                resolve(Object.assign(opt, {url: urlDelete}));
            });
        },

        _fetchInitCreate: function (entityId, data) {
            var self = this;
            return new Promise(function (resolve, reject) {
                var urlCreate = self._fetchUrlCreate(entityId, data);
                var opt = self._defaultOptions('POST', data);
                resolve(Object.assign(opt, {url: urlCreate}));
            });
        },


        // --- Component linker
        // --- ---------------------------
        __printResponseHeaders: function (response) {
            var myHeaders = response.headers;
            for (var pair of myHeaders.entries()) {
                console.log(pair[0] + ': ' + pair[1]);
            }
            return response;
        },

        _isResponseJson: function (response) {
            var contentType = response.headers.get('content-type');
            return (contentType && contentType.indexOf('application/json') !== -1)
        },

        _handleResponseRetrieve: function (response) {
//                console.log(response);
            var dataClone = Object.freeze(JSON.parse(JSON.stringify(response)));
            this.data = response;
            this._dataOrigin = dataClone;
            this.entityId = dataClone.id;
            return response;
        },

        _handleResponseCreate: function (responseJson) {
            var self = this;
            this.data.id = responseJson._id;
            this.entityId = responseJson._id;
            this.data.version = responseJson._version;
            return responseJson;
        },


        _handleResponseUpdate: function (responseJson) {
            if (responseJson.version) {
                this.data.version = responseJson.version;
            }
            return responseJson;
        },

        _handleResponseDelete: function (responseJson) {
            return responseJson;
        },

        // --- Conflict resolution handling
        // --- ---------------------------
        _handleConflictResolution: function (error) {

        },

        // --- Error handling
        // --- ---------------------------

        _handleErrorRetrieve: function (error) {
            console.log('--- error', error);
            console.log('--- error.response', error.response);
            console.log('--- error.response.status', error.response.status);
            console.log('--- error.status', error.status);
            this._fireErrorRetrieve(error);
        },

        _handleErrorUpdate: function (error) {
            console.log('--- error', error);
            if (error.status === 409) { // 409 Conflict Resolution
                return this._handleConflictResolution(error);
            }
            this._fireErrorUpdate(error);
        },
        _handleErrorCreate: function (error) {
            console.log('--- error', error);

            this._fireErrorCreate(error);
        },
        _handleErrorDelete: function (error) {
            console.log('--- error', error);
            this._fireErrorDelete(error);
        },

        // --- API Internal
        // --- ---------------------------

        _checkResponseStatus: function (response) {
            if (!response.ok) {
                return response.text().then(function (text) {
                    var error = new Error(response.status + '(' + response.statusText + ') : ' + text);
                    return Promise.reject(Object.assign(error, {response: response}, {
                        status: response.status,
                        statusText: response.statusText,
                        responseText: text
                    }));
                });
            }
            return response;
        },


        _fetchPromiseRetrieve: function (entityId) {
            return this._fetchInitRetrieve(entityId)
                    .then(this._fetchRequest.bind(this))
                    .then(this._checkResponseStatus.bind(this))
                    .then(this._transformResponseJson.bind(this))
                    .then(this._adapterResponseRetrieve.bind(this))
                    .then(this._handleResponseRetrieve.bind(this))
                    .catch(this._handleErrorRetrieve.bind(this));
        },

        _fetcPromiseUpdate: function (entityId, data) {
            return this._fetchInitUpdate(entityId, data)
                    .then(function (init) {
                        return this._fetchInitAddData(init, data);
                    }.bind(this))
                    .then(this._fetchRequest.bind(this))
                    .then(this._checkResponseStatus.bind(this))
                    .then(this._transformResponseJson.bind(this))
                    .then(this._adapterResponseUpdate.bind(this))
                    .then(this._handleResponseUpdate.bind(this))
                    .catch(this._handleErrorUpdate.bind(this));
        },

        _fetchPromiseDelete: function (entityId, data) {
            return this._fetchInitDelete(entityId, data)
                    .then(this._fetchRequest.bind(this))
                    .then(this._checkResponseStatus.bind(this))
                    .then(this._transformResponseJson.bind(this))
                    .then(this._adapterResponseDelete.bind(this))
                    .then(this._handleResponseDelete.bind(this))
                    .catch(this._handleErrorDelete.bind(this));
        },


        _fetchPromiseCreate: function (entityId, data) {
            return this._fetchInitCreate(entityId, data)
                    .then(function (init) {
                        return this._fetchInitAddData(init, data);
                    }.bind(this))
                    .then(this._fetchRequest.bind(this))
                    .then(this._checkResponseStatus.bind(this))
                    .then(this._transformResponseJson.bind(this))
                    .then(this._adapterResponseCreate.bind(this))
                    .then(this._handleResponseCreate.bind(this))
                    .catch(this._handleErrorCreate.bind(this));
        },


        // --- Event Response
        // --- ---------------------------

        /**
         * Fired when a resource are loaded.
         *
         * @event air-cruddy-retrieve
         */
        _fireResponseRetrieve: function (response) {
            this.fire('air-cruddy-retrieve', response);
        },

        // --- Event Error
        // --- ---------------------------

        /**
         * Fired error when a resource are loaded.
         *
         * @event air-cruddy-error-retrieve
         */
        _fireErrorRetrieve: function (error) {
            this.fire('air-cruddy-error-retrieve', error);
            this._fireError(error, 'retrieve');
        },
        /**
         * Fired error when a resource are loaded.
         *
         * @event air-cruddy-error-update
         */
        _fireErrorUpdate: function (error) {
            this.fire('air-cruddy-error-update', error);
            this._fireError(error, 'update');

        },
        /**
         * Fired error when a resource are loaded.
         *
         * @event air-cruddy-error-delete
         */
        _fireErrorDelete: function (error) {
            this.fire('air-cruddy-error-delete', error);
            this._fireError(error, 'delete');
        },
        /**
         * Fired error when a resource are loaded.
         *
         * @event air-cruddy-error-create
         */
        _fireErrorCreate: function (error) {
            this.fire('air-cruddy-error-create', error);
            this._fireError(error, 'create');
        },

        /**
         * Fired when error is raised
         *
         * @event air-cruddy-error
         */
        _fireError: function (error) {
            this.fire('air-cruddy-error', error);
        },
    }

</script>
