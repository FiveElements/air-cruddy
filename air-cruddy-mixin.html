<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../fire-crypto/fire-crypto-digest-behaviour.html">

<script>
    'use strict';

    /**
     * FiveElements Namespace definition
     */
    var FiveElements = FiveElements || {};

    /**
     * @polymerBehavior
     */
    FiveElements.AirCruddyBehavior = {

        properties: {
            /**
             * Auto Save
             */
            debug: {
                type: Boolean,
                value: false
            },
            /**
             * Auto Save
             */
            autoSave: {
                type: Boolean,
                value: false
            },
            /**
             * Url endpoint of the Rest Web-Service
             *
             */
            url: {
                type: String
            },
            /**
             * Entity Id of the resource to CRUD
             */
            entityId: {
                type: String,
                notify: true
            },
            /**
             * The data load from the URL endpoint of the Rest Web-Service
             */
            data: {
                type: Object,
                notify: true
            },
            /**
             * A backup of the Data Load
             */
            _dataOrigin: {
                type: Object
            },
            /**
             * Fetch Configuration :
             *
             * The mode you want to use for the request, e.g., cors, no-cors, same-origin, or navigate.
             */
            mode: {
                type: String,
                value: 'cors'
            },

            /**
             * Fetch Configuration :
             *
             * The cache mode you want to use for the request.
             */
            cache: {
                type: String,
                value: 'default'
            },

            /**
             * Fetch Configuration :
             *
             * The redirect mode to use: follow, error, or manual. In Chrome the default is follow
             */
            redirect: {
                type: String,
                value: 'follow'
            },
            /**
             * Fetch Configuration :
             *
             * A USVString specifying no-referrer, client, or a URL. The default is client.
             */
            referrer: {
                type: String,
                value: 'client'
            }
        },

        observers: [
            '_autosaveObserver(autoSave,data.*)',
            '_dataChangeObserver(data.*)',
            '_entityIdChangeObserver(entityId)',

        ],

        // --- Changed Observer
        // --- ---------------------------
        _autosaveObserver: function (autoSave, dataChange) {
            if (autoSave) {
//                    this.save();
            }
        },

        _entityIdChangeObserver: function (entityId) {
            if (entityId) {
                this.retrieve(entityId);
            }
        },

        // --- Dirty Changed
        // --- ---------------------
        _dataChangeObserver: function (changeRecord) {
            // https://github.com/FiveElements/air-cruddy/blob/iron-ajax/air-cruddy-dirty-behaviour.html
            console.log('### ', changeRecord.path + ' changed to ' + changeRecord.value, ' // ', changeRecord);

            // Compare the Change to Origin loaded data
            // -----------------------------------------
            // Extract the object prefix : 'data.'.length = 5
            var pathChanged = changeRecord.path.slice(5);
        },


        // --- mock
        // --- ---------------------------

        retrieveById: function (entityId) {
            console.log("Request Retrieve: ", entityId);
            this._fetchPromiseRetrieve(entityId).catch(function (error) {
                console.log('post error', error);
            });
        },


        // --- API
        // --- ---------------------------
        /**
         * Send Retrieve request to the Rest Web Service Server
         * @param entityId The entityId to load or if not defined the entityId deine in the 'air-cruddy' Web-Componnent
         */
        retrieve: function (entityId) {
//                var loadId = entityId || this.entityId;
            var loadId = this.entityId;
//            loadId = 'AVmyiew8OdPym37e2QYA';
            return this._fetchPromiseRetrieve(loadId);
        },

        /**
         * Send Update request to Server.
         */

        update: function () {
            return this._fetchPromiseUpdate(this.entityId, this.data);
        },

        /**
         * Send Delete request to Server.
         */
        delete: function () {
            return this._fetchPromiseDelete(this.entityId, this.data);
        },

        /**
         * Send Create request to Server.
         */
        create: function () {
            console.log('create data add ', this.data);
            return this._fetchPromiseCreate(null, this.data);
        },

        /**
         * Create new empty entity
         */
        newEntity: function () {
            this.entityId = null;
            this._dataOrigin = null;
            this.data = this._createEmptyEntity();
        },

        _createEmptyEntity: function () {
            return {};
        },

        /**
         * Clean all component State, like data loaded or entityid definition.
         */
        clean: function () {
            this.entityId = undefined;
            this._setDataWithClone(undefined);
        },

        /**
         * Restore the dat from with the last request retrieve.
         */
        reset: function () {
            var cloned = this._dataOrigin;
            this.data = cloned ? JSON.parse(JSON.stringify(cloned)) : cloned;
        },

        // --- Status
        // --- ---------------------------
        isStatusRetrieving: function (entityId, data, dataOrigin) {

        },
        isStatusUnset: function (data, dataOrigin) {
            return (dataOrigin === null);
        },
        isStatusCreate: function (data, dataOrigin) {
            return (dataOrigin === undefined);
        },
        isStatusUpdate: function (data, dataOrigin) {
            return (dataOrigin);
        },

        // --- Validation
        // --- ---------------------------

        validate: function () {
            var distributed = this.getContentChildren('#crudContent');
            var validateNodes = this._getValidateNodes();
            var isValid = validateNodes.reduce(function (acc, node) {
                var validateFunc = node['validate'].bind(node);
                var isValidNode = validateFunc();
                return acc;
            }, false);
        },

        _getValidateNodes: function () {
//            var nodes = Polymer.dom(this).children;
            var nodes = Polymer.dom(this).getEffectiveChildNodes();
            return Array.prototype.filter.call(nodes, function (n) {
                var validateFunc = n['validate'];
                var isValidateNode = (typeof  validateFunc === 'function');
                return isValidateNode;
            });
        },

        // --- Utility
        // --- ---------------------------
        _setDataWithClone: function (data) {
            var dataClone = data ? Object.freeze(JSON.parse(JSON.stringify(data))) : data;
            this.data = data;
            console.log('set Data : ' + JSON.stringify(data));
            this._dataOrigin = dataClone;
        },


        // --- Fetch Configuration
        // --- ---------------------------

        _defaultHearders: function () {
            var myHeaders = new Headers({
                'Content-Type': 'application/json' // "text/plain"
            });
            return myHeaders;
        },

        /**
         *
         * @param method
         * @param data
         * @returns {{method: *, mode: *, headers: *}}
         * @private
         */
        _defaultOptions: function (method, data) {
            var content = undefined;
            var myHeaders = this._defaultHearders();
            // https://developer.mozilla.org/en-US/docs/Web/API/Request/Request
            // method: The request method, e.g., GET, POST.
            // credentials: The request credentials you want to use for the request: omit, same-origin, or include. The default is omit.
            // integrity: Contains the subresource integrity value of the request (e.g., sha256-BpfBw7ivV8q2jLiT13fxDYAe2tJllusRSZ273h2nFSE=). (https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity)
            var init = {
                method: method,
                mode: this.mode,
                cache: this.cache,
                redirect: this.redirect,
                referrer: this.referrer,
                headers: myHeaders
            };
            return init;
        },


        _fetchUrlEntityId: function (entityId, version) {
            var url = this.url + '/' + entityId;
            if (version) {
                url += '?version=' + version;
            }
            return url;
        },

        _fetchUrlRoot: function () {
            return this.url;
        },


        // --- Elasticsearch API Transformer
        // --- ---------------------------
        _dataSerializerEntity: function (data) {
            return JSON.stringify(data);
        },

        /**
         * Adapt response from Retrieve Web-Service o the expected format
         * ```
         * {
             *   id: '',
             *   version: '',
             *   ...
             * }
         * ```
         */
        _adapterResponseRetrieve: function (res) {
            var responseJson = res.response;
            if (responseJson) {
                var data = JSON.parse(JSON.stringify(responseJson._source));
                data.id = responseJson._id;
                data.version = responseJson._version;
                // define
                res.response = data;
            }
            return res;
        },
        /**
         * Adapt response from Update Web-Service o the expected format
         * ```
         * {
             *   id: '',
             *   version: '',
             *   ...
             * }
         * ```
         */
        _adapterResponseUpdate: function (res) {
            var body = res.response;
            if (body) {
                var adaptJson = {
                    id: body._id,
                    version: body._version
                };
                body = Object.assign(adaptJson,body)
                res.response = body;
            }
            return res;
        },

        /**
         * Adapt response from Delete Web-Service o the expected format
         * ```
         * {
             *   id: 'The new entity Id',
             *   version: 'The version',
             *   ...
             * }
         * ```
         */
        _adapterResponseDelete: function (responseJson) {
            var adaptJson = {
                id: responseJson._id,
                version: responseJson._version
            };
            return Object.assign(adaptJson, {origin: responseJson});
        },

        /**
         * Adapt response from Create Web-Service o the expected format
         * ```
         * {
             *   id: 'The new entity Id',
             *   version: 'The version',
             *   ...
             * }
         * ```
         */
        _adapterResponseCreate: function (responseJson) {
            var adaptJson = {
                id: responseJson._id,
                version: responseJson._version
            };
            return Object.assign(adaptJson, {origin: responseJson});
        },

        /**
         * Adapt data model For Update or Create request
         *
         * @param opt Fetch configuration in format ``` { url:'', init:{}, data:{}}```
         */
        _adapterFetchInitData: function (opt) {
            // Create New Structure
            if (opt.data) {
                var data = JSON.parse(JSON.stringify(opt.data));
                delete data.id;
                delete data.version;
                // Register Data
                opt.data = data;
            }
            return opt;
        },

        /**
         * Adapt data model For Update request
         *
         * @param opt Fetch configuration in format ``` { url:'', init:{}, data:{}}```
         */
        _adapterFetchInitDataUpdate: function (opt) {
            return this._adapterFetchInitData(opt);
        },

        /**
         * Adapt data model For Create request
         *
         * @param opt Fetch configuration in format ``` { url:'', init:{}, data:{}}```
         */
        _adapterFetchInitDataCreate: function (opt) {
            return this._adapterFetchInitData(opt);
        },


        _transformToServerSavePartial: function (opt) {
            // Manage Differential
            if (opt.data) {
                var data = JSON.parse(JSON.stringify(opt.data));
                delete data.id;
                delete data.version;
                opt.data = {
                    "doc": data
                };
            }
            return opt;
        },

        // --- Elasticsearch API
        // --- -------------------------------
        _fetchUrlRetrieve: function (entityId, version) {
            return this._fetchUrlEntityId(entityId, version);
        },

        _fetchUrlUpdate: function (entityId, version) {
            return this._fetchUrlEntityId(entityId, version);
        },

        _fetchUrlDelete: function (entityId, version) {
            return this._fetchUrlEntityId(entityId, version);
        },

        _fetchUrlCreate: function (entityId, version) {
            return this._fetchUrlRoot();
        },

        // --- Fetch Request
        // --- -------------------------------

        /**
         * Fetch configuration for Retrieve request in format
         * ```js
         * {
         *   url: 'String',
         *   init: {},
         *   data: {}
         * }
         * ```
         */
        _fetchInitRetrieve: function (entityId, data) {
            var self = this;
            return new Promise(function (resolve, reject) {
                var version = data ? data.version : null;
                var urlGet = self._fetchUrlRetrieve(entityId, version);
                var opt = self._defaultOptions('GET');
                resolve({init: opt, url: urlGet});
            });
        },


        /**
         * Fetch configuration for Update request in format
         * ```js
         * {
         *   url: 'String',
         *   init: {},
         *   data: {}
         * }
         * ```
         */
        _fetchInitUpdate: function (entityId, data) {
            var self = this;
            return new Promise(function (resolve, reject) {
                var version = data ? data.version : null;
                var urlUpdate = self._fetchUrlUpdate(entityId, version);
                var opt = self._defaultOptions('PUT', data);
                resolve({init: opt, url: urlUpdate, data: data});
            });
        },

        /**
         * Fetch configuration for Delete request in format
         * ```js
         * {
         *   url: 'String',
         *   init: {},
         *   data: {}
         * }
         * ```
         */
        _fetchInitDelete: function (entityId, data) {
            var self = this;
            return new Promise(function (resolve, reject) {
                var version = data ? data.version : null;
                var urlDelete = self._fetchUrlDelete(entityId, version);
                var opt = self._defaultOptions('DELETE', data);
                resolve({init: opt, url: urlDelete, data: data});
            });
        },

        /**
         * Fetch configuration for Create request in format
         * ```js
         * {
         *   url: 'String',
         *   init: {}
         *   data: {}
         * }
         * ```
         */
        _fetchInitCreate: function (entityId, data) {
            var self = this;
            return new Promise(function (resolve, reject) {
                var urlCreate = self._fetchUrlCreate(entityId, data);
                var opt = self._defaultOptions('POST', data);
                resolve({init: opt, url: urlCreate, data: data});
            });
        },


        // --- Component linker
        // --- ---------------------------
        _extractResponseHeaders: function (response) {
            var myHeaders = response.headers;
            var headers = {};
            for (var pair of myHeaders.entries()) {
                headers[pair[0]] = pair[1];
            }
            return headers;
        },

        _isResponseJson: function (response) {
            var contentType = response.headers.get('content-type');
            return (contentType && contentType.indexOf('application/json') !== -1)
        },


        // --- Fetch Helper
        // --- ---------------------------
        _fetchRequest: function (opt) {
//            console.log('Fetch opt', JSON.stringify(opt));
            return window.fetch(opt.url, opt.init);
        },

        _checkResponseStatus: function (response) {
            console.log('check response : ' + response.ok);
            if (!response.ok) {
                return response.text().then(function (text) {
                    var error = new Error(response.status + '(' + response.statusText + ')');
                    return Promise.reject(Object.assign(error, {
                        status: response.status,
                        statusText: response.statusText,
                        responseText: text
                    }));
                });
            }
            return response;
        },

        _transformResponseJson: function (response) {
            var res = {
                status: response.status,
                statusText: response.statusText,
                url: response.url
            };
            return response.json().then(function (responseJson) {
                return Object.assign(res, {response: responseJson});
            });
        },

        // --- Fetch Data Helper
        // --- ---------------------------

        _fetchInitDataContentSerializer: function (opt) {
            if (opt.data) {
                opt.content = this._dataSerializerEntity(opt.data);
            }
            return opt;
        },

        _fetchInitDataContentRegister: function (opt) {
            var init = opt.init;
            var content = opt.content;
            if (content) {
                var contentLength = content.length;
                init.body = content;
                // Complete Headers
                var myHeaders = init.headers || new Headers();
                myHeaders.append("Content-Length", contentLength.toString());
                init.headers = myHeaders;
            }
            return opt;
        },

        // --- Fetch Digest Content for Integrity
        // --- ---------------------------

//        _fetchInitDataIntegrity: function (opt) {
//            var content = opt.content;
//            if (content) {
//                var integrityAlgo = 'SHA-384'; // allowed prefixes are sha256, sha384, and sha512
//                return this._digestPromise(integrityAlgo, content, 'base64')
//                        .then(function (integrityHash) {
//                            opt.integrity = integrityHash;
//                            console.log('integrity : ',opt);
//                            return opt;
//                        });
//            }
//            return opt;
//        },


        // --- Fetch Promise Logic
        // --- ---------------------------
        _fetchPromiseRetrieveRequest: function (entityId) {
            return this._fetchInitRetrieve(entityId)
                    .then(this._fetchRequest.bind(this)) // Do Request
                    .then(this._checkResponseStatus.bind(this))
                    .then(this._transformResponseJson.bind(this))
                    .then(this._adapterResponseRetrieve.bind(this))
        },

        _fetchPromiseRetrieve: function (entityId) {
            return this._fetchPromiseRetrieveRequest(entityId)
                    .then(this._handleResponseRetrieve.bind(this))
                    .then(this._fireResponseRetrieve.bind(this))
                    .catch(this._handleErrorRetrieve.bind(this));
        },

        _fetchPromiseUpdate: function (entityId, data) {
            return this._fetchInitUpdate(entityId, data)
                    .then(this._adapterFetchInitDataUpdate.bind(this))
                    .then(this._fetchInitDataContentSerializer.bind(this))
                    //                    .then(this._fetchInitDataIntegrity.bind(this))
                    .then(this._fetchInitDataContentRegister.bind(this))
                    .then(this._fetchRequest.bind(this)) // Do Request
                    .then(this._checkResponseStatus.bind(this))
                    .then(this._transformResponseJson.bind(this))
                    .then(this._adapterResponseUpdate.bind(this))
                    .then(this._handleResponseUpdate.bind(this))
                    .then(this._fireResponseUpdate.bind(this))
                    .catch(this._handleErrorUpdate.bind(this));
        },

        _fetchPromiseDelete: function (entityId, data) {
            return this._fetchInitDelete(entityId, data)
                    .then(this._fetchRequest.bind(this)) // Do Request
                    .then(this._checkResponseStatus.bind(this))
                    .then(this._transformResponseJson.bind(this))
                    .then(this._adapterResponseDelete.bind(this))
                    .then(this._handleResponseDelete.bind(this))
                    .then(this._fireResponseDelete.bind(this))
                    .catch(this._handleErrorDelete.bind(this));
        },


        _fetchPromiseCreate: function (entityId, data) {
            return this._fetchInitCreate(entityId, data)
                    .then(this._adapterFetchInitDataCreate.bind(this))
                    .then(this._fetchInitDataContentSerializer.bind(this))
                    //                    .then(this._fetchInitDataIntegrity.bind(this))
                    .then(this._fetchInitDataContentRegister.bind(this))
                    .then(this._fetchRequest.bind(this)) // Do Request
                    .then(this._checkResponseStatus.bind(this))
                    .then(this._transformResponseJson.bind(this))
                    .then(this._adapterResponseCreate.bind(this))
                    .then(this._handleResponseCreate.bind(this))
                    .then(this._fireResponseCreate.bind(this))
                    .catch(this._handleErrorCreate.bind(this));
        },


        // --- Response Handler
        // --- ---------------------------

        _handleResponseRetrieve: function (res) {
            var responseJson = res.response;
            this._setDataWithClone(responseJson);
            this.entityId = responseJson.id;
            return res;
        },

        _handleResponseCreate: function (responseJson) {
            var data = this.data;
            // Hydrate
            data.id = responseJson.id;
            if (responseJson.version) {
                data.version = responseJson.version;
            }
            this.entityId = data.id;
            this._setDataWithClone(data);
            return responseJson;
        },


        _handleResponseUpdate: function (responseJson) {
            var data = this.data;
            if (responseJson.version) {
                data.version = responseJson.version;
            }
            this._setDataWithClone(data);
            return responseJson;
        },

        _handleResponseDelete: function (responseJson) {
            this.clean();
            return responseJson;
        },


        // --- Error handling
        // --- ---------------------------

        _logError: function (error) {
            console.log('--- error :' + error);
        },

        _handleErrorRetrieve: function (error) {
            this._logError(error);
            var handlerStatus = this._getHandlerResponseWithSpecificStatus('_handleErrorRetrieve', error);
            if (handlerStatus) {
                return handlerStatus(error);
            }
            this._setDataWithClone(null);
            this._fireErrorRetrieve(error);
            return error;
        },

        _handleErrorUpdate: function (error) {
            this._logError(error);
            var handlerStatus = this._getHandlerResponseWithSpecificStatus('_handleErrorUpdate', error);
            if (handlerStatus) {
                return handlerStatus(error);
            }
            this._fireErrorUpdate(error);
            return error;
        },

        _handleErrorCreate: function (error) {
            this._logError(error);
            var handlerStatus = this._getHandlerResponseWithSpecificStatus('_handleErrorCreate', error);
            if (handlerStatus) {
                return handlerStatus(error);
            }
            this._fireErrorCreate(error);
            return error;
        },
        _handleErrorDelete: function (error) {
            this._logError(error);
            var handlerStatus = this._getHandlerResponseWithSpecificStatus('_handleErrorDelete', error);
            if (handlerStatus) {
                return handlerStatus(error);
            }
            this._fireErrorDelete(error);
            return error;
        },


        // --- Specific Error handling
        // --- ---------------------------
        _getHandlerResponseWithSpecificStatus: function (baseErrorFuncName, response) {
            var status = response.status;
            if (status) {
                var errorStatusFunc = baseErrorFuncName + status;
                var handlerForStatus = this[errorStatusFunc];
                if (typeof  handlerForStatus === 'function') {
                    // Manage Method Like : _handleErrorUpdate409
                    return handlerForStatus;
                }
            }
            return null;
        },


        // --- Event Response
        // --- ---------------------------

        /**
         * Fired when a resource are loaded.
         *
         * @event air-cruddy-retrieve
         */
        _fireResponseRetrieve: function (response) {
            this.fire('air-cruddy-retrieve', response);
            if (this.debug) console.log('Fire  air-cruddy-retrieve : ' + JSON.stringify(response));
            return response;
        },

        /**
         * Fired when a resource are updated.
         *
         * @event air-cruddy-update
         */
        _fireResponseUpdate: function (response) {
            this.fire('air-cruddy-update', response);
            return response;
        },

        /**
         * Fired when a resource are created.
         *
         * @event air-cruddy-create
         */
        _fireResponseCreate: function (response) {
            this.fire('air-cruddy-create', response);
            return response;
        },

        /**
         * Fired when a resource are deleted.
         *
         * @event air-cruddy-delete
         */
        _fireResponseDelete: function (response) {
            this.fire('air-cruddy-delete', response);
            return response;
        },

        // --- Event Error
        // --- ---------------------------

        /**
         * Fired error when a resource are loaded.
         *
         * @event air-cruddy-error-retrieve
         */
        _fireErrorRetrieve: function (error) {
            this.fire('air-cruddy-error-retrieve', error);
            return this._fireError(error, 'retrieve');
        },
        /**
         * Fired error when a resource are loaded.
         *
         * @event air-cruddy-error-update
         */
        _fireErrorUpdate: function (error) {
            this.fire('air-cruddy-error-update', error);
            return this._fireError(error, 'update');

        },
        /**
         * Fired error when a resource are loaded.
         *
         * @event air-cruddy-error-delete
         */
        _fireErrorDelete: function (error) {
            this.fire('air-cruddy-error-delete', error);
            return this._fireError(error, 'delete');
        },
        /**
         * Fired error when a resource are loaded.
         *
         * @event air-cruddy-error-create
         */
        _fireErrorCreate: function (error) {
            this.fire('air-cruddy-error-create', error);
            return this._fireError(error, 'create');
        },

        /**
         * Fired when error is raised
         *
         * @event air-cruddy-error
         */
        _fireError: function (error) {
            this.fire('air-cruddy-error', error);
            return error;
        },
    }


    //    FiveElements.AirCruddyBehavior = [
    //        FiveElements.FireCryptoDigestBehavior, FiveElements.AirCruddyBehaviorImpl
    //    ];

</script>
