<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-ajax/iron-ajax.html">

<script>

    /**
     * @polymerBehavior
     */
    Polymer.AirCruddyResponseBehavior = {

        properties: {

            reloadOnSave: {
                type: Boolean,
                value: false
            },
            reloadOnUpdate: {
                type: Boolean,
                value: false
            },
            reloadOnCreate: {
                type: Boolean,
                value: false
            }
        },


        // --- Entity Model
        // --- ---------------------------


        _setDataVersionFromResponse: function (data, reloadOnChange) {
            if (reloadOnChange) {
                var id = this._extractResponseId(data);
                this._entityGet(id);
            } else {
                var version = this._extractResponseVersion(data);
                if (version) {
                    this._setDataVersion(version);
                }
            }
        },
        _setDataIdFromResponse: function (data) {
            var id = this._extractResponseId(data);
            this._setDataId(id);
        },

        // --- Entity GET
        // --- ---------------------------

        _onResponseGet: function (detail) {
            var response = detail.response;
            this._setData(response);

            // TODO Resolve conflict is Needed
        },
        _onErrorGet: function (detail) {
            var error = detail.error;
        },


        // --- Entity Create
        // --- ---------------------

        _onResponseCreate: function (detail) {
            var response = detail.response;
            // 201 – OK – New resource has been created
            this._setDataIdFromResponse(response);
            this._setDataVersionFromResponse(response);
        },
        _onErrorCreate: function (detail) {
            var error = detail.error;
        },


        // --- Entity Update
        // --- ---------------------


        _onResponseUpdate: function (detail) {
            var response = detail.response;
            this._setDataVersionFromResponse(response, this.reloadOnSave);
            this._onResponseSave(detail);
        },
        _onErrorUpdate: function (detail) {
            var status = detail.status;
            // var resp = detail.response;
            if (status === 409) {
                // conflict resolution with reload data
                if (typeof  this.beginConflictBeResolution === 'function') {
                    this.beginConflictBeResolution();
                }
                // Reload Data anyway, what else could you do in this case !!! (Sorry for Your lost)
                this._entityGet(this.entityId);
            } else {
                this._onErrorSave(detail);
            }
        },



        // --- Entity Save handler
        // --- ---------------------
        _onResponseSave: function (detail) {
            var status = detail.status;
            var resp = detail.response;
            // Increment version or reload data ?
            if (this.reloadOnSave === true) {
                console.log('Reload on save');
                this._entityGet();
            } else {
                // FIXME Update version
                this._setDataVersion(resp._version);
            }
        },

        _onErrorSave: function (detail) {
            var status = detail.status;
            var resp = detail.response;
            if (status === 404) { // 404 Not Found
                this.showSaveErrorMessage('Entity Save Error : Entity Not Found');
            } else if (status === 409) { // 409 : Conflict
                this.showSaveErrorMessage('Entity Save Conflict');
                // conflict resolution with reload data
                // TODO  this.resolveConflict();
            } else {

            }
        },
        // --- Entity Delete Create
        // --- ---------------------

        _onResponseDelete: function (detail) {
//            var response = detail.response;
            // 204 – OK – The resource was successfully deleted
            this._unsetDataId();
        },

        _onErrorDelete: function (detail) {
            var error = detail.error;
        }


        // --- Other
        // --- ---------------------


    };
</script>
