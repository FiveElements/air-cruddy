<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-ajax/iron-ajax.html">

<script>

    /**
     * @polymerBehavior
     */
    Polymer.AirCruddyResponseBehavior = {

        properties: {

            reloadOnSave: {
                type: Boolean,
                value: false
            }
        },

        // --- Response Error Event
        // --- ---------------------------
        _extractErrorFromResponse: function (event) {
            console.error('Error : ', event.detail);
            console.error('Error request : ', event.detail.request.xhr);
            var response = event.detail.request.xhr.response;
            var error = event.detail.error;


            var status = response.statusCode; /// detail.xhr.status;
            var statusText = response.response;//detail.xhr.statusText;
            return {
                error: error,
                status: status,
                statusText: statusText
            };
        },


        // --- External Apis
        // --- ---------------------------

        _deserializeData: function (event) {
            var response = event.detail.response;
            return response;
        },


//        unsetDataId : function() {
//            throw new Error('Not Implemented');
//         },

        // --- Entity Serialization Apis
        // --- ---------------------------


        // --- Entity GET
        // --- ---------------------------

        _handleResponseGet: function (event) {
            console.log('Get Response:');
            var response = this._deserializeData(event);
            this._setData(response);
            this.fire('air-cruddy-get-response', response);
        },

        _handleErrorGet: function (event) {
            var error = this._extractErrorFromResponse(event);
            // Fire Event
            this.fire('air-cruddy-error', error);
            this.fire('air-cruddy-get-error', error);
        },


        // --- Entity Create
        // --- ---------------------

        _handleResponseCreate: function (event) {
            var status = event.detail.status;
            var resp = event.detail.response;
            // Define Create Existing id
            this._setDataId(resp._id);
            // Common Management
            this._handleResponseSave(event);
            // Fire Event
            this.fire('air-cruddy-create-response', resp);
        },

        _handleErrorCreate: function (event) {
            var error = this._extractErrorFromResponse(event);
            // Manage Error
            this._handleErrorSave(error);
            // Fire Event
            this.fire('air-cruddy-create-error', error);
        },


        // --- Entity Update
        // --- ---------------------
        _handleResponseUpdate: function (event) {
            var status = event.detail.status;
            var resp = event.detail.response;
            // Common Management
            this._handleResponseSave(event);
            // Fire Event
            this.fire('air-cruddy-update-response', resp);
        },
        _handleErrorUpdate: function (event) {
            var error = this._extractErrorFromResponse(event);
            this._handleErrorSave(event);
            // Fire Event
            this.fire('air-cruddy-update-error', error);
        },

        // --- Entity Save handler
        // --- ---------------------
        _handleResponseSave: function (event) {
            var status = event.detail.status;
            var resp = event.detail.response;
            // Increment version or reload data ?
            if (this.reloadOnSave === true) {
                console.log('Reload on save');
                this._entityGet();
            } else {
                // Update version
                this._setDataVersion(resp._version);
            }
            // Fire Event
            this.fire('air-cruddy-save-response', resp);
            this.fire('air-cruddy-error', error);
        },

        _handleErrorSave: function (event) {
            var status = event.detail.status;
            var resp = event.detail.response;
            if (status === 404) { // 404 Not Found
                this.showSaveErrorMessage('Entity Save Error : Entity Not Found');
            } else if (status === 409) { // 409 : Conflict
                this.showSaveErrorMessage('Entity Save Conflict');
                // conflict resolution with reload data
                // TODO  this.resolveConflict();
            } else {

            }
        },
        // --- Entity Delete Create
        // --- ---------------------
        _handleResponseDelete: function (event) {
            this._unsetDataId();
            this.fire('air-cruddy-delete-response', event.detail.response);
        },
        _handleErrorDelete: function (event) {
            var eventTest = this._extractErrorFromResponse(event);
            // Fire Event
            this.fire('air-cruddy-error', eventTest);
            this.fire('air-cruddy-delete-error', eventTest);
        },

        // --- Other
        // --- ---------------------


    };
</script>
