<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="air-cruddy-mixin.html">

<!--
`air-cruddy`
An Polymer element that manage CRUD Operations

The `air-cruddy` provides lightweight way to implement all CRUD (Create, Retrieve, Update, Delete) Operations on an REST Api with all the expected services :
 - Validation
 - Conflict Resolution on 409
 - Auto Save Feature

@group air-elements
@demo demo/index.html
-->

<dom-module id="air-cruddy">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>
        <h2>Hello [[url]]</h2>
    </template>

    <script>

        Polymer({

              is: 'air-cruddy',


                    properties: {
                        url: {
                            type: String
                        },
                        entityId: {
                            type: String,
                            notify: true
                        },
                        data: {
                            type: Object
                        }
                    },

            // --- Changed Observer
            // --- ---------------------------


            // --- API
            // --- ---------------------------


            retrieve:function () {
                this._fetchPromiseRetrieve().then(function(response){
                    if(response.ok) {

                    }
                });
            },

            update:function () {

            },

            delete:function () {

            },

            // --- API Adapter
            // --- ---------------------------

            _defaultHearders:function (content) {
                var headers =  new Headers({
                    'Content-Type': 'application/json' // "text/plain"
                });
                if (content) {
                    headers.append("Content-Length", content.length.toString());
                }
                return headers;
            },

            _defaultOptions:function (method, data) {
                var content = undefined;
                if (data) {
                    content = this._dataSerializerEntity(data);
                }
                var headers = this._defaultHearders(content);
                var opt = {
                    method: method,
                    mode: 'cors',
                    cache: 'default',
                    redirect: 'follow',
                    headers: headers
                };
                if (content) {
                    opt.body = content;
                }
                return opt;
            },

            _fetchUrlEntityId:function () {
                return this.url + '/' + this.entityId;
            },

            _fetchUrlCreate:function () {
                return this.url ;
            },


            // --- Data Serialiser
            // --- ---------------------------
            _dataSerializerEntity:function (data) {
                return JSON.stringify(data);
            },

            // --- API Adapter
            // --- ---------------------------
            _fetchPromiseRetrieve:function () {
                var opt = this._defaultOptions('GET');
                return fetch(this._fetchUrlEntityId(), opt);
            },


            _fetchPromiseCreate:function () {
                var opt = this._defaultOptions('POST',this.data);
                return fetch(this._fetchUrlCreate(), opt);
            },


            _fetcPromiseUpdate:function () {
                var opt = this._defaultOptions( 'PUT',this.data );
                return fetch(this._fetchUrlEntityId(), opt);
            },

            _fetchPromiseDelete:function () {
                var opt = this._defaultOptions('DELETE' );
                return fetch(this._fetchUrlEntityId(), opt);
            },


            // --- API
            // --- ---------------------------

            _fetchPromise:function (url, init) {
                return fetch(url, init).then(function(response ) {
                    return response.json();
                });
            },


        });
    </script>
</dom-module>
