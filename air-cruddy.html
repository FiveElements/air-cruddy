<link rel="import" href="../polymer/polymer.html">


<!--
`air-cruddy`
An Polymer element that manage CRUD Operations

The `air-cruddy` provides lightweight way to implement all CRUD (Create, Retrieve, Update, Delete) Operations on an REST Api with all the expected services :
 - Validation
 - Conflict Resolution on 409
 - Auto Save Feature

@group air-elements
@demo demo/index.html
-->

<dom-module id="air-cruddy">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>
        <button on-tap="retrieve">Retrieve</button>
        <button on-tap="update">Update</button>
        <h2 on-tap="retrieve">Hello [[url]]</h2>
    </template>

    <script>

        Polymer({

            is: 'air-cruddy',

            properties: {
                url: {
                    type: String
                },
                entityId: {
                    type: String,
                    notify: true
                },
                data: {
                    type: Object,
                    notify: true
                },
                _dataOrigin: {
                    type: Object
                }
            },

            // --- Changed Observer
            // --- ---------------------------


            // --- API
            // --- ---------------------------


            retrieve: function () {
                console.log("Request Retrieve");
                this._fetchPromiseRetrieve().then(function (response) {

                        console.log("Request Retrieve   ---> OK");

                });
            },

            update: function () {
                console.log("Request Update");
            },

            delete: function () {

            },

            // --- API Adapter
            // --- ---------------------------

            _defaultHearders: function (content) {
                var myHeaders = new Headers({
                    'Content-Type': 'application/json' // "text/plain"
                });
                if (content) {
                    console.log('Content-Length', content.length.toString());
                    myHeaders.append('Content-Length', content.length.toString());
                }
                console.log(myHeaders);
                return myHeaders;
            },

            _defaultOptions: function (method, data) {
                var content = undefined;
                if (data) {
                    content = this._dataSerializerEntity(data);
                }
                var myHeaders = this._defaultHearders(content);
                console.log('Content-Type', myHeaders.get('Content-Type')); // false
                var opt = {
                    method: method,
                    mode: 'cors', // FIXME
//                    cache: 'default', redirect: 'follow',
                    headers: myHeaders
                };
                if (content) {
                    opt.body = content;
                }
                return opt;
            },

            _fetchUrlEntityId: function () {
                return this.url + '/' + this.entityId;
            },

            _fetchUrlCreate: function () {
                return this.url;
            },


            // --- Data Serialiser
            // --- ---------------------------
            _dataSerializerEntity: function (data) {
                return JSON.stringify(data);
            },

            // --- API Adapter
            // --- ---------------------------
            _fetchPromiseRetrieve: function () {
                var opt = this._defaultOptions('GET');
                var urlGet = this._fetchUrlEntityId();
                return window.fetch(urlGet, opt).then(function (response) {
                    return response.json();
                }).then(this._hydrateFetchRetrieve.bind(this));
            },

            _hydrateFetchRetrieve(response) {
                console.log(response);
                this.data = response._source;
                return response;
            },

            _fetchPromiseCreate: function () {
                var opt = this._defaultOptions('POST', this.data);
                return fetch(this._fetchUrlCreate(), opt);
            },


            _fetcPromiseUpdate: function () {
                var opt = this._defaultOptions('PUT', this.data);
                return fetch(this._fetchUrlEntityId(), opt);
            },

            _fetchPromiseDelete: function () {
                var opt = this._defaultOptions('DELETE');
                return fetch(this._fetchUrlEntityId(), opt);
            },


            // --- API
            // --- ---------------------------

            _fetchPromise: function (url, init) {
                console.log("Fetch URL", url, JSON.stringify(init));
                return window.fetch(url, init).then(function (response) {
                    var contentType = response.headers.get("content-type");
                    console.log("contentType Response", contentType);
                    console.log("OK Response", response.ok);
                    console.log("Status Response", response.status);
                    console.log("Fetch Response",  response);
//                    if (response.ok) {}
                    return response.json();
                }).catch(function (err) {
                    console.error(err);
                });
            },


        });
    </script>
</dom-module>
