<link rel="import" href="../polymer/polymer.html">


<!--
`air-cruddy`
An Polymer element that manage CRUD Operations

The `air-cruddy` provides lightweight way to implement all CRUD (Create, Retrieve, Update, Delete) Operations on an REST Api with all the expected services :
 - Validation
 - Conflict Resolution on 409
 - Auto Save Feature

@group air-elements
@demo demo/index.html
-->

<dom-module id="air-cruddy">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>
        <button on-tap="retrieve">Retrieve</button>
        <button on-tap="retrieveById">Retrieve 404</button>
        <button on-tap="update">Update</button>
        <h2 on-tap="retrieve">Hello [[url]]</h2>
    </template>

    <script>

        Polymer({

            is: 'air-cruddy',

            properties: {
                url: {
                    type: String
                },
                entityId: {
                    type: String,
                    notify: true
                },
                data: {
                    type: Object,
                    notify: true
                },
                _dataOrigin: {
                    type: Object
                },
                mode: {
                    type: String,
                    value: 'cors'
                }
            },

            // --- Changed Observer
            // --- ---------------------------


            // --- mock
            // --- ---------------------------

            retrieveById: function (entityId) {
                console.log("Request Retrieve: ", entityId);
                this.entityId = '404';
                this._fetchPromiseRetrieve().catch(function (error) {
                    console.log('post error', error);
                });
            },


            // --- API
            // --- ---------------------------


            retrieve: function () {
                console.log("Request Retrieve");
                this._fetchPromiseRetrieve();
            },

            update: function () {
                console.log("Request Update");
            },

            delete: function () {

            },

            // --- API Adapter
            // --- ---------------------------

            _defaultHearders: function (content) {
                var myHeaders = new Headers({
                    'Content-Type': 'application/json' // "text/plain"
                });
                if (content) {
                    console.log('Content-Length', content.length.toString());
                    myHeaders.append('Content-Length', content.length.toString());
                }
                return myHeaders;
            },

            _defaultOptions: function (method, data) {
                var content = undefined;
                if (data) {
                    content = this._dataSerializerEntity(data);
                }
                var myHeaders = this._defaultHearders(content);
                var opt = {
                    method: method,
                    mode: this.mode,
//                    cache: 'default', redirect: 'follow',
                    headers: myHeaders
                };
                if (content) {
                    opt.body = content;
                }
                return opt;
            },

            _fetchUrlEntityId: function () {
                return this.url + '/' + this.entityId;
            },

            _fetchUrlRoot: function () {
                return this.url;
            },


            // --- Data Serialiser
            // --- ---------------------------
            _dataSerializerEntity: function (data) {
                return JSON.stringify(data);
            },

            // --- Elasticsearch API Transformer
            // --- ---------------------------

            _transformFromServerRetrieve: function (response) {
                var data = JSON.parse(JSON.stringify(response._source));
                data.id = response._id;
                data.version = response._version;
                return data;
            },

            _transformToServerSave: function (dataToSave) {
                var data = JSON.parse(JSON.stringify(dataToSave));
                delete data.id;
                delete data.version;
                return data;
            },

            _transformToServerSavePartial: function (dataToSave) {
                // Manage Differential
                var data = JSON.parse(JSON.stringify(dataToSave));
                delete data.id;
                delete data.version;
                return {
                    "doc": data
                };
            },

            // --- Elasticsearch Response Handler
            // --- -------------------------------
            _fetchUrlRetrieve: function () {
                return this._fetchUrlEntityId();
            },

            _fetchUrlUpdate: function () {
                return this._fetchUrlEntityId();
            },

            _fetchUrlDelete: function () {
                return this._fetchUrlEntityId();
            },

            _fetchUrlCreate: function () {
                return this._fetchUrlRoot();
            },

            // --- Component linker
            // --- ---------------------------
            _handleResponseRetrieve: function (response) {
//                console.log(response);
                var dataClone = JSON.parse(JSON.stringify(response));
                this.data = response;
                this._dataOrigin = dataClone;
                return response;
            },
            _handleResponseCreate: function (response) {
                return response;
            },

            _handleResponseUpdate: function (response) {
                return response;
            },


            // --- Error handling
            // --- ---------------------------

            _handleRetrieveError: function (error) {
                console.log('--- error', error);
                console.log('--- error.response', error.response);
                console.log('--- error.response.status', error.response.status);
                console.log('--- error.status', error.status);

            },

            // --- API Internal
            // --- ---------------------------

            _checkResponseStatus: function (response) {
                if (!response.ok) {
                    return response.text().then(function (text) {
                        var error = new Error(response.status + '(' + response.statusText + ') : ' + text);
                        return Promise.reject(Object.assign(error, {response}, {
                            status: response.status,
                            statusText: response.statusText,
                            responseText: text
                        }));
                    });
                }
                return response;
            },


            _fetchPromiseRetrieve: function () {
                var opt = this._defaultOptions('GET');
                return window.fetch(this._fetchUrlRetrieve(), opt)
                        .then(this._checkResponseStatus.bind(this))
                        .then(function (response) {
                            return response.json();
                        }).then(this._transformFromServerRetrieve.bind(this))
                        .then(this._handleResponseRetrieve.bind(this))
                        .catch(this._handleRetrieveError.bind(this));
            },

            _fetcPromiseUpdate: function () {
                var opt = this._defaultOptions('PUT', this.data);
                return fetch(this._fetchUrlUpdate(), opt).then(function (response) {
                    return response.json();
                }).then(this._handleResponseUpdate.bind(this));
            },

            _fetchPromiseCreate: function () {
                var opt = this._defaultOptions('POST', this.data);
                return fetch(this._fetchUrlCreate(), opt).then(function (response) {
                    return response.json();
                }).then(this._handleResponseCreate.bind(this));
            },


            _fetchPromiseDelete: function () {
                var opt = this._defaultOptions('DELETE');
                return fetch(this._fetchUrlEntityId(), opt);
            },


            // --- API
            // --- ---------------------------

            _fetchPromise: function (url, init) {
                console.log("Fetch URL", url, JSON.stringify(init));
                return window.fetch(url, init).then(function (response) {
                    var contentType = response.headers.get("content-type");
                    console.log("contentType Response", contentType);
                    console.log("OK Response", response.ok);
                    console.log("Status Response", response.status);
                    console.log("Fetch Response", response);
//                    if (response.ok) {}
                    return response.json();
                }).catch(function (err) {
                    console.error(err);
                });
            },


        });
    </script>
</dom-module>
