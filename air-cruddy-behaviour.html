<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="air-cruddy-differential-behaviour.html">

<script>

    /**
     * @polymerBehavior
     */
    Polymer.AirCruddyBehaviorImpl = {
        properties: {

            entityId: {
                type: String,
                notify: true,
                observer: '_entityIdChanged'
            },

            data: {
                type: Object,
                notify: true
            },

            dataOri: Object,

            _isModeCreate: {
                type: Boolean,
                computed: '_computedCreationMode(data._id)'
            }

        },

        listeners: {
            'air-cruddy-response-get': '_handleResponseGet',
            'air-cruddy-error-get': '_handleErrorGet',
            'air-cruddy-response-create': '_handleResponseCreate',
            'air-cruddy-error-create': '_handleErrorCreate',
            'air-cruddy-response-update': '_handleResponseUpdate',
            'air-cruddy-error-update': '_handleErrorUpdate',
            'air-cruddy-response-delete': '_handleResponseDelete',
            'air-cruddy-error-delete': '_handleErrorDelete'
        },



        // --- Computed Properties
        // --- ---------------------------
        _computedCreationMode: function (dataId) {
            return !dataId;
        },

        // --- Life Cycle
        // --- ---------------------------

        ready: function () {
            // console.log('Ready behaviors', 'entityId', this.entityId);
        },

        // --- Accessor
        // --- ---------------------------

        /**
         * Place the form in status of creating a new entity.
         */
        newEntity: function () {
            this.entityId = '';
        },

        _setData: function (data) {
            this.set('data', data);
            this._dataSnapshot(data);
        },

        _setDataVersion: function (newVersion) {
            this.set('data._version', newVersion);
        },
        _setDataId: function (newDataId) {
            this.entityId = newDataId;
            this.set('data._id', newDataId);
        },
        _unsetDataId: function () {
            this.entityId = null;
            this.set('data', null);
        },
        _createEmptyEntity: function () {
            return {
                _id: null,
                _version: null,
                _source: {}
            };
        },

        // --- Changed
        // --- ---------------------------
        _entityIdChanged: function (newValue, oldValue) {
            //console.log('entityIdChanged behaviors', oldValue, '--->', newValue);
            if (this.entityId === null) {
                // Blank case, no model to create
                this._setData(null);
            } else if (this.entityId === '' || this.entityId === 'new') {
                // Create Model
                this._setData(this._createEmptyEntity());
                //console.log('_entityIdChanged create empty data ', this.data);
            } else if (!this.data || !this.data._id || this.data._id !== this.entityId) {
                // console.log('_entityIdChanged get data ', this.entityId);
                // Update Mode
                this._entityGet(this.entityId);
                // console.log('entityidChanged load data ', this.entityId);
            }
        },

        // --- Public Api
        // --- ---------------------------
        entityGet: function (entityId) {
            var loadId = entityId || this.entityId;
            this._entityGet(loadId);
        },


        // --- Required Api
        // --- ---------------------------
        _entityGet: function (entityId) {
            console.warn('Required Api implementation for function : [%s]', '_entityGet');
            //throw new Error('Required Api implementation for function : '+ '_entityGet');
        },
        _entityCreate: function (data) {
            console.warn('Required Api implementation for function : [%s]', '_entityCreate');
        },
        _entityUpdate: function (data) {
            console.warn('Required Api implementation for function : [%s]', '_entityUpdate');
        },
        _entityDelete: function (data) {
            console.warn('Required Api implementation for function : [%s]', '_entityDelete');
        },
        validate: function (callback) {
            console.warn('Required Api implementation for function : [%s]', 'validate');
            return true;
        },

        // --- Public Apis
        // --- ---------------------
        save: function () {
            // Dirty Check
            var diffData = this._diffDataSource(this.notifNotDiff.bind(this));
            if (!diffData) {
                // console.log('Save entity == NO Diff ');
                return;
            }
            // Validation
            if (!this.validate(this.notifValidityErrors.bind(this))) {
                console.log('Save entity == NOT Valid ');
                return false;
            }

            console.log('Save operation', this._isModeCreate);
            // Is Diff and Valid, need to be saved
            if (this._isModeCreate) {
                this._entityCreate(this._cloneData());
            } else {
                // TODO ? { _id: this.data._id, _version: this.data._version, _source: diffData }
                this._entityUpdate(this._cloneData());
            }
        },

        // --- Notification
        // --- ---------------------
        notifNotDiff: function (diff) {
            if (!diff) {
                this.showSaveErrorMessage('Saved not needed.');
            }
        },

        notifValidityErrors: function (errorNodes) {
            console.log('notifValidityErrors ', errorNodes);
            // TODO Display Errors
        },

        showSaveErrorMessage: function (msg) {
            //  this.toastSaveErrorMessage = msg;
            //this.$.toastSaveError.show();
            console.log(msg);
        },

        // --- Data Snapshot
        // --- ---------------------
        _dataSnapshot: function (data) {
            this.set('dataOri', this._cloneData(data));
        },

        _cloneData: function (data) {
            // data = data || this.data;
            if (data) {
                return JSON.parse(JSON.stringify(data));
            }
            return null;
        },
        _diffDataSource: function (notDiffCallback) {
            console.log('_diffDataSource : dataOri :', this.dataOri, 'data : ', this.data);
            var diff = this._diffProperties(this.dataOri._source || {}, this.data._source || {});
            if (notDiffCallback) {
                notDiffCallback(diff);
            }
            return diff;
        },

        // --- Entity GET
        // --- ---------------------------

        _handleResponseGet: function (response) {
            console.log('------------------ Get One', event.detail);
            var detail = response.detail;
            this._onResponseGet(detail);
        },
        _handleErrorGet: function (response) {
            var detail = response.detail;
            this._onErrorGet(detail);
        },

        _onResponseGet: function (detail) {
            console.warn('Required Api implementation for function : [%s]', '_onResponseGet', detail);
        },
        _onErrorGet: function (detail) {
            console.warn('Required Api implementation for function : [%s]', '_onErrorGet', detail);
        },




        // --- Entity Create
        // --- ---------------------
        _handleResponseCreate: function (response) {
            var detail = response.detail;
            this._onResponseCreate(detail);
        },
        _handleErrorCreate: function (response) {
            var detail = response.detail;
            this._onErrorCreate(detail);
        },


        _onResponseCreate: function (detail) {
            console.warn('Required Api implementation for function : [%s]', '_onResponseCreate', detail);
        },
        _onErrorCreate: function (detail) {
            console.warn('Required Api implementation for function : [%s]', '_onErrorCreate', detail);
        },



        // --- Entity Update
        // --- ---------------------

        _handleResponseUpdate: function (response) {
            var detail = response.detail;
            this._onResponseUpdate(detail);
        },
        _handleErrorUpdate: function (response) {
            var detail = response.detail;
            this._onErrorUpdate(detail);
        },

        _onResponseUpdate: function (detail) {
            console.warn('Required Api implementation for function : [%s]', '_onResponseUpdate', detail);
        },
        _onErrorUpdate: function (detail) {
            console.warn('Required Api implementation for function : [%s]', '_onErrorUpdate', detail);
        },


        // --- Entity Delete
        // --- ---------------------

        _handleResponseDelete: function (response) {
            var detail = response.detail;
            this._onResponseDelete(detail);
        },
        _handleErrorDelete: function (error) {
            var detail = response.detail;
            this._onErrorDelete(detail);
        },

        _onResponseDelete: function (detail) {
            console.warn('Required Api implementation for function : [%s]', '_onResponseDelete', detail);
        },

        _onErrorDelete: function (detail) {
            console.warn('Required Api implementation for function : [%s]', '_onErrorDelete', detail);
        }

        // --- Other
        // --- ---------------------


    };

    /**
     * @polymerBehavior
     */
    Polymer.AirCruddyBehavior = [Polymer.AirCruddyDifferentialBehavior, Polymer.AirCruddyBehaviorImpl];


</script>
