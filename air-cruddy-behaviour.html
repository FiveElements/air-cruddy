<link rel="import" href="../polymer/polymer.html">


<script>

    /**
     * FiveElements Namespace definition
     */
    var FiveElements = FiveElements || {};

    /**
     * @polymerBehavior
     */
    FiveElements.AirCruddyBehavior = {
        properties: {
           // Data
            entityId: {
                type: String,
                notify: true,
                observer: '_entityIdChanged'
            },

            data: {
                type: Object,
                notify: true
            },
            // Configuration Behaviours
            reloadOnSave: {
                type: Boolean,
                value: false
            },
            reloadOnUpdate: {
                type: Boolean,
                value: false
            },
            reloadOnCreate: {
                type: Boolean,
                value: false
            },

            saveWait: {
                type: Number,
                value: 10
            },

            // Internal Properties
            dataOri: Object,

            _isModeCreate: {
                type: Boolean,
                computed: '_computedCreationMode(data._id)'
            }

        },

        listeners: {
            'air-cruddy-response-get': '_handleResponseGet',
            'air-cruddy-error-get': '_handleErrorGet',
            'air-cruddy-response-create': '_handleResponseCreate',
            'air-cruddy-error-create': '_handleErrorCreate',
            'air-cruddy-response-update': '_handleResponseUpdate',
            'air-cruddy-error-update': '_handleErrorUpdate',
            'air-cruddy-response-delete': '_handleResponseDelete',
            'air-cruddy-error-delete': '_handleErrorDelete'
        },



        // --- Computed Properties
        // --- ---------------------------
        _computedCreationMode: function (dataId) {
            return !dataId;
        },

        // --- Life Cycle
        // --- ---------------------------

        ready: function () {
            // console.log('Ready behaviors', 'entityId', this.entityId);
        },

        // --- Accessor
        // --- ---------------------------
        /**
         * Place the form in status of creating a new entity.
         */
        newEntity: function () {
            this.entityId = '';
        },

        _setData: function (data) {
            // Define Snapshot in first, to permit data change comparison to be accured
            this._dataSnapshot(data);
            this.set('data', data);
        },

        _setDataVersion: function (newVersion) {
            this.set('data._version', newVersion);
        },
        _setDataId: function (newDataId) {
            this.set('data._id', newDataId);
            this.entityId = newDataId;
        },
        _unsetDataId: function () {
            this.set('data', null);
            this.entityId = null;
        },

        _createEmptyEntity: function () {
            return {
                _id: null,
                _version: null,
                _source: {}
            };
        },



        // --- Changed
        // --- ---------------------------
        _entityIdChanged: function (newValue, oldValue) {
            //console.log('entityIdChanged behaviors', oldValue, '--->', newValue);
            if (this.entityId === null) {
                // Blank case, no model to create
                this._setData(null);
            } else if (this.entityId === '' || this.entityId === 'new') {
                // Create Model
                this._setData(this._createEmptyEntity());
                //console.log('_entityIdChanged create empty data ', this.data);
            } else if (!this.data || !this.data._id || this.data._id !== this.entityId) {
                // console.log('_entityIdChanged get data ', this.entityId);
                // Update Mode
                console.log('----------- set ID with clean Data :', this.entityId);
                this._setData(null);
                this.entityGet(this.entityId);
                // console.log('entityidChanged load data ', this.entityId);
            }
        },

        // --- Public Api
        // --- ---------------------------
        _getRequestEntityId: function (entityId, entityVersion) {
            var opt = {};
            if (entityId) {
                opt._id = entityId;
                opt._version = entityVersion;
            } else {
                if (this.data) {
                    opt._id = this._extractResponseId(this.data);
                    opt._version = this._extractResponseVersion(this.data);
                }
            }
            return opt;
        },

        entityGet: function (entityId, entityVersion) {
            var opt = this._getRequestEntityId(entityId, entityVersion);
            console.log('Entity Get', opt);
            this._entityGet(opt);
        },

        entityUpdate: function (entityId, entityVersion) {
            var opt = this._getRequestEntityId(entityId, entityVersion);
            var dataClone = this._cloneData();
            this._entityUpdate(opt, dataClone);
        },

        entityCreate: function (entityId, entityVersion) {
            var opt = this._getRequestEntityId(entityId, entityVersion);
            this._entityCreate(opt, this._cloneData());
        },

        entityDelete: function (entityId, entityVersion) {
            var opt = this._getRequestEntityId(entityId, entityVersion);
            this._entityDelete(opt);
        },


        // --- Required Api
        // --- ---------------------------
        _entityGet: function (entityId) {
            console.warn('Required Api implementation for function : [%s]', '_entityGet');
            //throw new Error('Required Api implementation for function : '+ '_entityGet');
        },
        _entityCreate: function (entityId,  data, version) {
            console.warn('Required Api implementation for function : [%s]', '_entityCreate');
        },
        _entityUpdate: function (entityId, data, version) {
            console.warn('Required Api implementation for function : [%s]', '_entityUpdate');
        },
        _entityDelete: function (entityId, version) {
            console.warn('Required Api implementation for function : [%s]', '_entityDelete');
        },
        validate: function (callback) {
            console.warn('Required Api implementation for function : [%s]', 'validate');
            return true;
        },

        isDataDirty: function () {
            // Need to be Overided to compute the Differential Status
          return true;
        },

        // --- Public Apis
        // --- ---------------------
        isNeedToSave: function() {
            // Validation
            if (!this.validate(this.notifValidityErrors.bind(this))) {
                console.log('Save entity == NOT Valid ');
                return false;
            }
            // Dirty Check
            var isDirty = this.isDataDirty();
            return isDirty;
//            var diffData = this._diffDataSource(this.notifNotDiff.bind(this));
//            if (!diffData) {
//                // console.log('Save entity == NO Diff ');
//                return false;
//            }
            return true;
        },

        save: function () {
            this.debounce('air-cruddy-save', this._save.bind(this), this.saveWait);
        },

        _save: function () {
            if (!this.isNeedToSave()) {
                return false;
            }
            // Is Diff and Valid, need to be saved
            if (this._isModeCreate) {
                this.entityCreate();
            } else {
                this.entityUpdate();
            }
        },

        // --- Notification
        // --- ---------------------
//        notifNotDiff: function (diff) {
//            if (!diff) {
//                this.showSaveErrorMessage('Saved not needed.');
//            }
//        },

        notifValidityErrors: function (errorNodes) {
            console.log('notifValidityErrors ', errorNodes);
            // TODO Display Errors
        },

        showSaveErrorMessage: function (msg) {
            //  this.toastSaveErrorMessage = msg;
            //this.$.toastSaveError.show();
            console.log(msg);
        },

        // --- Data Snapshot
        // --- ---------------------
        _dataSnapshot: function (data) {
            this.set('dataOri', this._cloneData(data));
        },

        _cloneData: function (data) {
             data = data || this.data;
            if (data) {
                var dataClone =  JSON.parse(JSON.stringify(data));
                return dataClone;
            }
            return null;
        },
//
//        _diffDataSource: function (notDiffCallback) {
//            console.log('_diffDataSource : dataOri :', this.dataOri, 'data : ', this.data);
//            var diff = this._diffProperties(this.dataOri._source || {}, this.data._source || {});
//            if (notDiffCallback) {
//                notDiffCallback(diff);
//            }
//            return diff;
//        },


        // --- Entity Model
        // --- ---------------------------
        _setDataVersionFromResponse: function (data, reloadOnChange) {
            if (reloadOnChange) {
                var id = this._extractResponseId(data);
                this._entityGet(id);
            } else {
                var version = this._extractResponseVersion(data);
                if (version) {
                    this._setDataVersion(version);
                }
            }
        },

        _setDataIdFromResponse: function (data) {
            var id = this._extractResponseId(data);
            this._setDataId(id);
        },



        // --- Entity Response For Specific Status
        // --- -----------------------------------------
        _handleResponseWithSpecificStatus: function (baseErrorFuncName, event ) {
            var detail =  event.detail;
            var status = detail.status;
            var eatEvent = false;
            if (status) {
                var errorStatusFunc = baseErrorFuncName + status;
                if (typeof  this[errorStatusFunc] === 'function') {
                    // Manage Method Like : _onErrorUpdate409
                    eatEvent = this[errorStatusFunc](event);
                    if (eatEvent) {
                        event.stopPropagation();
                    }
                }
            }
            return eatEvent;
        },


        // --- Entity GET
        // --- ---------------------------
        _handleResponseGet: function (event) {
            var detail = event.detail;
            if (!this._handleResponseWithSpecificStatus('_handleResponseGet', event)) {
                var response = detail.response;
                this._setData(response);
                // Special Use case 409
                if (typeof  this['_handleGetForConflictBeResolution'] === 'function') {
                    this['_handleGetForConflictBeResolution'](event);
                }
            }
        },

        _handleErrorGet: function (event) {
            var detail = event.detail;
            console.log('_handleErrorGet : ', detail);
            if (!this._handleResponseWithSpecificStatus('_handleErrorGet', event)) {
                var error = detail.error;
                // TODO Manage the error at least 404
            }
        },



        // --- Entity Delete
        // --- ---------------------
        _handleResponseDelete: function (event) {
            var detail = event.detail;
            if (!this._handleResponseWithSpecificStatus('_handleResponseDelete', event)) {
                // 204 – OK – The resource was successfully deleted
                this._unsetDataId();
            }
        },

        _handleErrorDelete: function (event) {
            var detail = event.detail;
            if (!this._handleResponseWithSpecificStatus('_handleErrorDelete', event)) {
                var error = detail.error;
            }
        },
 

        // --- Entity Create
        // --- ---------------------
        _handleResponseCreate: function (event) {
            var detail = event.detail;
            console.log('_handleResponseCreate : ', detail);
            if (!this._handleResponseWithSpecificStatus('_handleResponseCreate', event)) {
                var response = detail.response;
                console.log('_handleResponseCreate No Specifc for response: ', response);
                // 201 – OK – New resource has been created
                this._setDataIdFromResponse(response);
                this._setDataVersionFromResponse(response);
            }
        },

        _handleErrorCreate: function (event) {
            var detail = event.detail;
            if (!this._handleResponseWithSpecificStatus('_handleErrorCreate', event)) {
                var error = detail.error;
            }
        },


        // --- Entity Update
        // --- ---------------------
        _handleResponseUpdate: function (event) {
            var detail = event.detail;
            var response = detail.response;
            this._setDataVersionFromResponse(response, this.reloadOnSave);
            this._onResponseSave(detail);
        },

        _handleErrorUpdate: function (event) {
            var detail = event.detail;
           //console.error('_handleErrorUpdate ',  detail.status,  detail);
            if (!this._handleResponseWithSpecificStatus('_handleErrorUpdate', event)) {
                this._onErrorSave(detail);
            }
        },


        // --- Entity Save handler
        // --- ---------------------
        _onResponseSave: function (detail) {
            var status = detail.status;
            var resp = detail.response;
            // Increment version or reload data ?
            if (this.reloadOnSave === true) {
                var id = this._extractResponseId(resp);
                console.log('Reload  on save Entity, ', id);
                this._entityGet(id);
            } else {
                // FIXME Update version
                this._setDataVersion(resp._version);
            }
        },

        _onErrorSave: function (detail) {
            var status = detail.status;
            if (status === 404) { // 404 Not Found
                this.showSaveErrorMessage('Entity Save Error : Entity Not Found');
            } else if (status === 409) { // 409 : Conflict
                var resp = detail.response;
                this.showSaveErrorMessage('Entity Save Conflict');
                // conflict resolution with reload data
                // TODO  this.resolveConflict();
            } else {

            }
        }

        // --- Other
        // --- ---------------------


    };

</script>
