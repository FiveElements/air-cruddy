<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-ajax/iron-ajax.html">

<script>

    /**
     * FiveElements Namespace definition
     */
    var FiveElements = FiveElements || {};


    /**
     * @polymerBehavior
     */
    FiveElements.AirCruddyAjaxInitBehavior = {
        properties: {
            /**
             *  Define the Rest Api to Use,
             *  By default is 'air-cruddy-ajax' but other are available :
             *  'air-cruddy-ajax-es'
             */
            crudApi: {
                type: String,
                notify: true,
                value: 'air-cruddy-ajax'
            },
            endpoint: {
                type: String,
                notify: true,
                observer: '_endpointChanged'
            },

            /**
             * Internal
             */
            _requestCrud: Object

        },


        // --- Life Cycle
        // --- ---------------------------

        created: function () {

        },
        ready: function () {
            // Object that handles the ajax form submission request.
            this._requestCrud = this._createIronAjax(this.crudApi);
            // Add to dom for event bubling
            Polymer.dom(this).appendChild(this._requestCrud);
            this._playAutoRequestWhenReady();
            // Log
            // console.log('End Ready behaviors', 'endpoint', this.endpoint);
        },


        // --- Service Instantiation
        // --- ---------------------------
        _createIronAjax: function (componentName) {
            //  console.log('Create ajax service : ', componentName);
            var requestBot = document.createElement(componentName);
            requestBot.endpoint = this.endpoint;
            return requestBot;
        },

        _endpointChanged: function () {
            if (this._requestCrud) {
                this._requestCrud.endpoint = this.endpoint;
            }
        },

        // --- Request Auto when Ready
        // --- ---------------------------

        _addAutoRequestWhenReady: function (requestFunction) {
            if (this.autoRequestWhenReady) {
                this.autoRequestWhenReady.push(requestFunction);
            } else {
                this.autoRequestWhenReady = [requestFunction];
            }
        },
        _playAutoRequestWhenReady: function () {
            if (this.autoRequestWhenReady) {
                this.autoRequestWhenReady.forEach(function (todo) {
                    if (todo) {
                        todo();
                    }
                });
            }
            this.autoRequestWhenReady = undefined;
        },


        // --- Entity Model
        // --- ---------------------------

        _extractResponseVersion: function (data) {
            return this._requestCrud._extractResponseVersion(data);
        },
        _extractResponseId: function (data) {
            return this._requestCrud._extractResponseId(data);
        },

        // --- Entity GET
        // --- ---------------------------

        /**
         * Called to request the get the entity from server.
         */
        _entityGet: function (opt, ver) {
            if (this._requestCrud) {
                console.log('arguments : ', arguments);
                var fn = this._requestCrud._entityGet;
                return fn.apply(this._requestCrud, arguments);
            } else {
                // Do request when Ready
                var that = this;
                var todoAgrs = arguments;
                var todo = function () {
                    var fn =  that._requestCrud._entityGet;
                    return fn.apply(that._requestCrud, todoAgrs);
                };
                this._addAutoRequestWhenReady(todo);
            }
        },


        // --- Entity Create
        // --- ---------------------
        /**
         * Called to request the create the entity to server.
         */
        _entityCreate: function () {
           return  this._requestCrud._entityCreate.apply(this._requestCrud, arguments);
        },


        // --- Entity Update
        // --- ---------------------
        /**
         * Called to request the update the entity to server.
         */
        _entityUpdate: function () {
            return  this._requestCrud._entityUpdate.apply(this._requestCrud, arguments);
        },


        // --- Entity Delete
        // --- ---------------------
        /**
         * Called to request the delete the entity to server.
         */
        _entityDelete: function () {
            return  this._requestCrud._entityDelete.apply(this._requestCrud, arguments);
        },


        // --- Other
        // --- ---------------------

    };


</script>
