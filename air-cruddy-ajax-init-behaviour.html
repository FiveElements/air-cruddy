<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-ajax/iron-ajax.html">

<script>


    /**
     * @polymerBehavior
     */
    Polymer.AirCruddyAjaxInitBehavior = {
        properties: {
            /**
             *  Define the Rest Api to Use,
             *  By default is 'air-cruddy-ajax' but other are available :
             *  'air-cruddy-ajax-es'
             */
            crudApi: {
                type: String,
                notify: true,
                value: 'air-cruddy-ajax'
            },
            endpoint: {
                type: String,
                notify: true,
                observer: '_endpointChanged'
            }

        },

//        listeners: {
//            'air-cruddy-error': '_handleErrorGet',
//            'air-cruddy-response-get': '_handleResponseGet',
//            'air-cruddy-response-create': '_handleResponseCreate',
//            'air-cruddy-response-update': '_handleResponseUpdate',
//            'air-cruddy-response-delete': '_handleResponseDelete'
//        },


        // --- Life Cycle
        // --- ---------------------------

        created: function () {

        },
        ready: function () {
            // Object that handles the ajax form submission request.
            this._requestCrud = this._createIronAjax(this.crudApi);
            this._playAutoRequestWhenReady();
            // Log
           // console.log('End Ready behaviors', 'endpoint', this.endpoint);
        },



        // --- Service Instantiation
        // --- ---------------------------
        _createIronAjax: function (componentName) {
          //  console.log('Create ajax service : ', componentName);
            var requestBot = document.createElement(componentName);
            requestBot.endpoint = this.endpoint;
            // Register Listener
            requestBot.addEventListener( 'air-cruddy-response-get', this._handleResponseGet.bind(this));
            requestBot.addEventListener( 'air-cruddy-error-get', this._handleErrorGet.bind(this));
            requestBot.addEventListener( 'air-cruddy-response-create', this._handleResponseCreate.bind(this));
            requestBot.addEventListener( 'air-cruddy-error-create', this._handleErrorCreate.bind(this));
            requestBot.addEventListener( 'air-cruddy-response-update', this._handleResponseUpdate.bind(this));
            requestBot.addEventListener( 'air-cruddy-error-update', this._handleErrorUpdate.bind(this));
            requestBot.addEventListener( 'air-cruddy-response-delete', this._handleResponseDelete.bind(this));
            requestBot.addEventListener( 'air-cruddy-error-delete', this._handleErrorDelete.bind(this));
            return requestBot;
        },

        _endpointChanged: function () {
            if (this._requestCrud) {
                this._requestCrud.endpoint = this.endpoint;
            }
        },

        // --- Request Auto when Ready
        // --- ---------------------------

        _addAutoRequestWhenReady: function ( requestFunction ) {
            if (this.autoRequestWhenReady) {
                this.autoRequestWhenReady.push(requestFunction);
            } else {
                this.autoRequestWhenReady= [requestFunction];
            }
        },
        _playAutoRequestWhenReady: function () {
            if (this.autoRequestWhenReady) {
                this.autoRequestWhenReady.forEach(function (todo) {
                    if (todo) {
                        todo();
                    }
                });
            }
            this.autoRequestWhenReady = undefined;
        },


        // --- Entity GET
        // --- ---------------------------

        /**
         * Called to request the get the entity from server.
         */
        _entityGet: function (opt, ver) {
            if ( this._requestCrud) {
                this._requestCrud._entityGet(opt, ver);
            } else {
                // Do request when Ready
                var that = this;
                var entityId = this.entityId;
                var todo = function() {
                    that._requestCrud._entityGet(entityId);
                };
                this._addAutoRequestWhenReady(todo);
            }
        },


        _handleResponseGet: function (response) {
            var detail = response.detail;
            this._onResponseGet(detail);
            this.fire('air-cruddy-response-get', detail);
        },
        _handleErrorGet: function (response) {
            console.log('air-cruddy-ajax _handleErrorGet : ', response);
            var detail = response.detail;
            this._handleErrorGet(detail);
            this.fire('air-cruddy-error-get', detail);
        },

        _onResponseGet: function (detail) {
            console.warn('Required Api implementation for function : [%s]', '_onResponseGet', detail);
        },
        _onErrorGet: function (detail) {
            console.warn('Required Api implementation for function : [%s]', '_onErrorGet', detail);
        },


        // --- Entity Create
        // --- ---------------------
        /**
         * Called to request the create the entity to server.
         */
        _entityCreate: function (data) {
            this._requestCrud._entityCreate(data);
        },

        _handleResponseCreate: function (response) {
            var detail = response.detail;
            this._onResponseCreate(detail);
            this.fire('air-cruddy-response-create', detail);
        },
        _handleErrorCreate: function (response) {
            var detail = response.detail;
            this._onErrorCreate(detail);
            this.fire('air-cruddy-error-create', detail);
        },


        _onResponseCreate: function (detail) {
            console.warn('Required Api implementation for function : [%s]', '_onResponseCreate', detail);
        },
        _onErrorCreate: function (detail) {
            console.warn('Required Api implementation for function : [%s]', '_onErrorCreate', detail);
        },


        // --- Entity Update
        // --- ---------------------
        /**
         * Called to request the update the entity to server.
         */
        _entityUpdate: function (data) {

            this._requestCrud._entityUpdate(data);
        },

        _handleResponseUpdate: function (response) {
            var detail = response.detail;
            this._onResponseUpdate(detail);
            this.fire('air-cruddy-response-update', detail);
        },
        _handleErrorUpdate: function (response) {
            var detail = response.detail;
            this._onErrorUpdate(detail);
            this.fire('air-cruddy-error-update', detail);
        },

        _onResponseUpdate: function (detail) {
            console.warn('Required Api implementation for function : [%s]', '_onResponseUpdate', detail);
        },
        _onErrorUpdate: function (detail) {
            console.warn('Required Api implementation for function : [%s]', '_onErrorUpdate', detail);
        },



        // --- Entity Delete
        // --- ---------------------
        /**
         * Called to request the delete the entity to server.
         */
        _entityDelete: function (data) {
            this._requestCrud._entityDelete(data);
        },


        _handleResponseDelete: function (response) {
            var detail = response.detail;
            this._onResponseDelete(detail);
            this.fire('air-cruddy-response-delete', detail);
        },
        _handleErrorDelete: function (error) {
            var detail = response.detail;
            this._onErrorDelete(detail);
            this.fire('air-cruddy-error-delete', detail);
        },

        _onResponseDelete: function (detail) {
            console.warn('Required Api implementation for function : [%s]', '_onResponseDelete', detail);
        },

        _onErrorDelete: function (detail) {
            console.warn('Required Api implementation for function : [%s]', '_onErrorDelete', detail);
        }



        // --- Other
        // --- ---------------------


    };


</script>
